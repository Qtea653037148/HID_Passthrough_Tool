<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HID Passthrough Tool</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100vh;
      background-color: #f7f7ff;
    }

    div {
      height: calc(100% - 4rem);
      padding: 2rem;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      grid-template-rows: 2rem 1fr;
      row-gap: 1rem;
      column-gap: 2rem;
    }

    textarea {
      resize: none;
      overflow-y: scroll;
      overflow-x: hidden;
      padding: 1rem;
    }

    .container {
      display: flex;
      align-items: center;
      height: 200px;
      border: 1px solid black;
    }

    .child {
      display: inline-block;
      height: 100%;
      vertical-align: middle;
    }
  </style>
  <script>
    if ("hid" in navigator) {
      // 浏览器支持hid
    } else {
      alert("Your browser is not support Web HID API.");
    }
  </script>
</head>

<body>
  <div>
    <button id="btnOpen">连接</button>
    <button id="btnSend">发送</button>
    <button id="btnClear">接收</button>
    <button id="bluetooth">蓝牙</button>


    <textarea id="iptLog" readonly></textarea>
    <textarea id="iptOutput">FE 05 02</textarea>
    <textarea id="iptInput" readonly></textarea>
    <div class="child">

      <p id="sliderValue">100</p>
      <input style="width: 200px" ; type="range" min="0" max="255" value="100" id="slider" class="container">



      <div style="width: 300px" ;>

        <button id="btnCol">颜色1</button>
        <button id="color2">颜色2</button>
        <button id="color3">颜色3</button>

      </div>


    </div>
  </div>

  <script>
    const btnOpen = document.querySelector("#btnOpen");
    const btnSend = document.querySelector("#btnSend");
    const btnClear = document.querySelector("#btnClear");
    const btnCol = document.querySelector("#btnCol");
    const color2 = document.querySelector("#color2");
    const color3 = document.querySelector("#color3");
    const bluetooth = document.querySelector("#bluetooth");
    const iptLog = document.querySelector("#iptLog");
    const iptOutput = document.querySelector("#iptOutput");
    const iptInput = document.querySelector("#iptInput");

    if (navigator.bluetooth) {
      // 浏览器支持蓝牙API
      iptLog.value += "浏览器支持蓝牙API\n\n";
    } else {
      // 浏览器不支持蓝牙API
      iptLog.value += "浏览器不支持蓝牙API\n\n";
    }

    iptLog.value += "HID Passthrough Tool\n\n";
    iptLog.value += "This is an HID Passthrough device read/write Tool.\n\n";
    iptLog.value += "Device must have one collection with one input and one output.\n\n";
    iptLog.value += "https://github.com/NaisuXu/HID_Passthrough_Tool\n\n";
    iptLog.value += "光盐交互网页端hid通信测试版本\n\n";
    iptLog.value += "光盐交互网页端蓝牙通信测试版本\n\n";




    let device; // 需要连接或已连接的设备
    let inputDataLength = 32; // 发送数据包长度
    let outputDataLength = 32; // 发送数据包长度




    // 打开设备相关操作
    btnOpen.onclick = async () => {
      try {
        // requestDevice方法将显示一个包含已连接设备列表的对话框，用户选择可以并授予其中一个设备访问权限
        //  const devices = await navigator.hid.requestDevice({ filters: [] });

        const devices = await navigator.hid.requestDevice({
          filters: [{
            vendorId: 0x0483,  // 根据VID进行过滤
            productId: 0x5750, // 根据PID进行过滤
            productName: "CUSTOM1",
          },],
        });

        // let devices = await navigator.hid.getDevices(); // getDevices方法可以返回已连接的授权过的设备列表

        if (devices.length == 0) {
          iptLog.value += "No device selected\n\n";
          iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部
          return;
        }

        device = devices[0]; // 选择列表中第一个设备
        console.log(device.productName);

        if (device.productName != "CUSTOM1")
          device = devices[1];
        console.log(device);
        console.log(devices);

        if (!device.opened) {
          // 检查设备是否打开
          await device.open(); // 打开设备

          // 下面几行代码和我的自定义的透传的HID设备有关
          // 我的设备中有一个collection，包含一个input、一个output
          // inputReports和outputReports数据是Array，reportSize是8
          // reportCount表示一包数据的字节数，USB-FS 和 USB-HS 设置的reportCount最大值不同
          if (device.collections[0].inputReports[0].items[0].isArray && device.collections[0].inputReports[0].items[0].reportSize === 8) {

            inputDataLength = device.collections[0].inputReports[0].items[0].reportCount ?? 0;
          }
          if (device.collections[0].outputReports[0].items[0].isArray && device.collections[0].outputReports[0].items[0].reportSize === 8) {
            // 发送数据包长度必须和报告描述符中描述的一致
            outputDataLength = device.collections[0].outputReports[0].items[0].reportCount ?? 0;
          }

          iptLog.value += `Open device: \n${device.productName}\nPID-${device.productId} VID-${device.vendorId}\ninputDataLength-${inputDataLength} outputDataLength-${outputDataLength}\n\n`;
          iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部
        }
        // await device.close(); // 关闭设备
        // await device.forget() // 遗忘设备

        // 电脑接收到来自设备的消息回调
        device.oninputreport = (event) => {
          console.log(event); // event中包含device、reportId、data等内容

          let array = new Uint8Array(event.data.buffer); // event.data.buffer就是接收到的inputreport包数据了
          let hexstr = "";
          for (const data of array) {
            hexstr += (Array(2).join(0) + data.toString(16).toUpperCase()).slice(-2) + " "; // 将字节数据转换成（XX ）形式字符串
          }
          iptInput.value += hexstr;
          iptInput.scrollTop = iptInput.scrollHeight; // 滚动到底部

          iptLog.value += `Received ${event.data.byteLength} bytes\n\n`;
          iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部
        };

      } catch (error) {
        iptLog.value += `${error}\n\n`;
        iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部
      }
    };

    // 发送数据相关操作
    btnSend.onclick = async () => {
      try {
        if (!device?.opened) {
          throw "Device not opened";
        }

        const outputData = new Uint8Array(32); // 要发送的数据包

        let outputDatastr = iptOutput.value.replace(/\s+/g, ""); // 去除所有空白字符
        if (outputDatastr.length % 2 == 0 && /^[0-9a-fA-F]+$/.test(outputDatastr)) {
          // 检查长度和字符是否正确
          // 一包长度不能大于报告描述符中规定的长度
          const byteLength = outputDatastr.length / 2 > outputDataLength ? outputDataLength : outputDatastr.length / 2;
          // 将字符串转成字节数组数据
          for (let i = 0; i < byteLength; i++) {
            outputData[i] = parseInt(outputDatastr.substr(i * 2, 2), 16);
          }
        } else {
          throw "Data is not even or 0-9、a-f、A-F";
        }

        await device.sendReport(0, outputData); // 发送数据，第一个参数为reportId，填0表示不使用reportId
        iptLog.value += `Send ${outputData.length} bytes\n\n`;
        iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部

      } catch (error) {
        iptLog.value += `${error}\n\n`;
        iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部
      }
    };

    function convertToHexadecimal(decimalNumber) {
      let hexadecimalNumber = (Array(2).join(0) + decimalNumber.toString(16).toUpperCase()).slice(-2) + " "; // 将字节数据转换成（XX ）形式字符串
      return hexadecimalNumber;
    };

    const slider = document.getElementById("slider");
    const sliderValue = document.getElementById("sliderValue");
    slider.oninput = function () {
      sliderValue.innerHTML = this.value;


      let hexstr = "FE 05 ";
      let val = parseInt(this.value);
      hexstr += convertToHexadecimal(val);
      iptOutput.value = "";
      iptOutput.value = hexstr; // 将数值转为16进制字符串

      //发送
      btnSend.onclick();


    };


    // 全局HID设备拔出事件
    navigator.hid.ondisconnect = (event) => {
      device = null; // 释放当前设备
      iptLog.value += "hid断开了设备";
      iptLog.value += `HID disconnected:\n${event.device.productName}\nPID ${event.device.productId} VID ${event.device.vendorId}\n\n`;
      iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部
    };
    function get_one_key_color(key_num) {
      let color_msg = "[0:0:12779056][1:0:13041209][2:0:13237828][3:0:13303374][4:0:13631066][5:0:13827686][6:0:14024307][7:0:14286464][8:0:14614159][9:0:14941855][10:0:15204016][11:0:15531713][12:0:15924946][13:0:5117184][14:0:0][0:1:12975677][1:1:13237831][2:1:13434449][3:1:13696605][4:1:13893225][5:1:14089845][6:1:14352002][7:1:14614161][8:1:14941857][9:1:15204016][10:1:15531713][11:1:15990485][12:1:16252649][13:1:16711422][14:1:15393534][0:2:13368912][1:2:13696608][2:2:13958763][3:2:14155384][4:2:14352005][5:2:14679701][6:2:15007395][7:2:15335092][8:2:15662790][9:2:15990489][10:2:16383724][11:2:16447486][12:2:15393534][13:2:14602750][14:2:13745918][0:3:13762148][1:3:14155386][2:3:14417543][3:3:14810775][4:3:15072933][5:3:15269558][6:3:15728329][7:3:16056027][8:3:16449263][9:3:16250622][10:3:15261694][11:3:14470910][12:3:13680126][13:3:10883662][14:3:975438][0:4:14286464][1:4:14876313][2:4:15072935][3:4:15400632][4:4:15728330][5:4:16187103][6:4:16449268][7:4:16184318][8:4:15195646][9:4:14404606][10:4:13613822][11:4:12758014][12:4:2736718][13:4:10714878][14:4:741966][0:5:14876316][1:5:15204016][2:5:15531713][3:5:16252646][4:5:16580343][5:5:16056028][6:5:15261694][7:5:14470910][8:5:13350654][9:5:12428286][10:5:11834878][11:5:0][12:5:10253310][13:5:9594622][14:5:9265150][15:0:16711112][16:0:16711112][17:0:16711112][18:0:16645319][15:1:16711112][16:1:16711112][17:1:16711112][18:1:16645319][15:2:16711112][16:2:16711112][17:2:16711112][18:2:16645319][15:3:16711112][16:3:16711112][17:3:16711112][18:3:7410944][15:4:16711112][16:4:16711112][17:4:16645319][18:4:8481134]"
      //解析颜色信息

      let i = Math.floor(key_num / 15);
      let j = key_num % 15;

      let anjian_rgb = color_msg.split(":")[i * 30 + j * 2 + 2];
      anjian_rgb = anjian_rgb.split("]")[0];
      console.log(key_num, i, j, anjian_rgb);
      return anjian_rgb;
    };
    btnCol.onclick = async () => {



      try {
        if (!device?.opened) {
          throw "Device not opened";

        }

        const Custom_table = new Uint8Array(32);
        for (let i = 0; i < 9; i++) {
          Custom_table[0] = 3;
          Custom_table[1] = i * 10 + 1;
          for (let j = 1; j <= 10; j++) {
            let r, g, b;
            let key_num = i * 10 + j - 1;

            let key_color = get_one_key_color(key_num);
            r = (key_color & 0xff0000) >> 16;
            g = (key_color & 0x00ff00) >> 8;
            b = (key_color & 0x0000ff) >> 0;
            Custom_table[j * 3 - 1] = r;     //r
            Custom_table[j * 3] = g;   //g
            Custom_table[j * 3 + 1] = b;   //b
          }
          await device.sendReport(0, Custom_table); // 发送数据，第一个参数为reportId，填0表示不使用reportId
        }
        for (let i = 0; i < 32; i++)
          Custom_table[i] = 0;
        Custom_table[0] = 0xfe;
        Custom_table[1] = 1;
        Custom_table[2] = 3;
        await device.sendReport(0, Custom_table); // 发送数据，第一个参数为reportId，填0表示不使用reportId

      } catch (error) {
        iptLog.value += `${error}\n\n`;
        iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部
      }
    };
    color2.onclick = async () => {

      try {
        if (!device?.opened) {
          throw "Device not opened";

        }

        const Custom_table = new Uint8Array(32);
        for (let i = 0; i < 9; i++) {
          Custom_table[0] = 3;
          Custom_table[1] = i * 10 + 1;
          for (let j = 1; j <= 10; j++) {
            let r, g, b;
            let key_num = i * 10 + j - 1;
            let key_color = 0xffff00;
            r = (key_color & 0xff0000) >> 16;
            g = (key_color & 0x00ff00) >> 8;
            b = (key_color & 0x0000ff) >> 0;
            Custom_table[j * 3 - 1] = r;     //r
            Custom_table[j * 3] = g;   //g
            Custom_table[j * 3 + 1] = b;   //b
          }
          await device.sendReport(0, Custom_table); // 发送数据，第一个参数为reportId，填0表示不使用reportId
        }
        for (let i = 0; i < 32; i++)
          Custom_table[i] = 0;
        Custom_table[0] = 0xfe;
        Custom_table[1] = 1;
        Custom_table[2] = 3;
        await device.sendReport(0, Custom_table); // 发送数据，第一个参数为reportId，填0表示不使用reportId

      } catch (error) {
        iptLog.value += `${error}\n\n`;
        iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部
      }
    };
    color3.onclick = async () => {

      try {
        if (!device?.opened) {
          throw "Device not opened";

        }

        const Custom_table = new Uint8Array(32);
        for (let i = 0; i < 9; i++) {
          Custom_table[0] = 3;
          Custom_table[1] = i * 10 + 1;
          for (let j = 1; j <= 10; j++) {
            let r, g, b;
            let key_num = i * 10 + j - 1;
            let key_color = 0x00ffff;
            r = (key_color & 0xff0000) >> 16;
            g = (key_color & 0x00ff00) >> 8;
            b = (key_color & 0x0000ff) >> 0;
            Custom_table[j * 3 - 1] = r;     //r
            Custom_table[j * 3] = g;   //g
            Custom_table[j * 3 + 1] = b;   //b
          }
          await device.sendReport(0, Custom_table); // 发送数据，第一个参数为reportId，填0表示不使用reportId
        }
        for (let i = 0; i < 32; i++)
          Custom_table[i] = 0;
        Custom_table[0] = 0xfe;
        Custom_table[1] = 1;
        Custom_table[2] = 3;
        await device.sendReport(0, Custom_table); // 发送数据，第一个参数为reportId，填0表示不使用reportId

      } catch (error) {
        iptLog.value += `${error}\n\n`;
        iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部
      }
    };




    // 全局HID设备插入事件
    navigator.hid.onconnect = (event) => {

      console.log("HID connected: ", event.device); // device 的 collections 可以看到设备报告描述符相关信息
      iptLog.value += "hid连接了新设备";
      iptLog.value += `HID connected:\n${event.device.productName}\nPID ${event.device.productId} VID ${event.device.vendorId}\n\n`;
      iptLog.scrollTop = iptLog.scrollHeight; // 滚动到底部
    };






    // 清空数据接收窗口
    btnClear.onclick = () => {
      iptInput.value = "";
    };

    bluetooth.onclick = () => {
      //请求蓝牙设备

      navigator.bluetooth.requestDevice({

        filters: [//过滤器
          {
            name: 'SHU·壹'
          }, {
            name: 'JSD Keyboard'
          },
        ],
        optionalServices: ['battery_service'] // Required to access service later.
      })
        .then((device) => { //控制台输出设备名称并连接
          console.log(device.name);
          console.log(device);


          return device.gatt.connect();
        })
        .then((server) => { //控制台输出设备服务

          console.log('蓝牙设备成功连接');
          console.log(server);
          // server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e')
          //  server.getPrimaryService('Battery')//电量
          return server.getPrimaryService('battery_service');

          console.log('运行正常？');




        })
        .then(service => {//控制台输出设备服务

          console.log('蓝牙选择uuid 成功');
          console.log(service);
          // return service.getCharacteristic('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
          // return service.getCharacteristic('BatteryLevel');
          return service.getCharacteristic('battery_level');


        })
        .then(characteristic => {
          console.log('蓝牙读取信息');
          console.log(characteristic);
          // 写入数据的示例代码
          characteristic.writeValue(new Uint8Array([0xFE, 0xF6]));
          console.log(characteristic.readValue());
          return characteristic.readValue();
        })
        .then(value => {
          // 读取到的数据
          console.log('蓝牙读取到数据');
          console.log(`Battery percentage is ${value.getUint8(0)}`);
          console.log(value);
        })
        .catch((error) => { //错误捕捉
          console.error(error);
        });

    };







  </script>
</body>

</html>